!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("Wowza",[],n):"object"==typeof exports?exports.Wowza=n():e.Wowza=n()}(window,(function(){return function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=0)}([function(e,n,t){"use strict";t.r(n),t.d(n,"Connection",(function(){return P}));var r={debug:function(e,n){console.group(e),console.debug(n),console.groupEnd()},info:function(e,n){console.group(e),console.info(n),console.groupEnd()},warn:function(e,n){console.group(e),console.warn(n),console.groupEnd()},error:function(e,n){console.group(e),console.error(n),console.groupEnd()}};function o(e,n,t,r,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(r,o)}function i(e){return function(){var n=this,t=arguments;return new Promise((function(r,i){var a=e.apply(n,t);function c(e){o(a,r,i,c,s,"next",e)}function s(e){o(a,r,i,c,s,"throw",e)}c(void 0)}))}}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function c(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function u(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var f=window.RTCPeerConnection,d=window.RTCIceCandidate,l=window.RTCSessionDescription,p=function(){function e(n,t,r){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.stream=null,this.ws=null,this.pc=null,this.endpoint=n,this.streamInfo=t,this.userData={sessionId:t.sessionId},this.videoConfig={bitRate:360,frameRate:64,codec:"42e01f",index:-1},this.audioConfig={bitRate:64,codec:"opus",index:-1},this.peerConnectionConfig={iceServers:[]},this.SDPOutput=new Object,r&&(r.userData&&(this.userData=c({},this.userData,{},r.userData)),r.video&&(this.videoConfig=c({},this.videoConfig,{},r.video)),r.audio&&(this.audioConfig=c({},this.audioConfig,{},r.audio)),r.peerConnection&&(this.peerConnectionConfig=c({},this.peerConnectionConfig,{},r.peerConnection)))}var n,t,o;return n=e,(t=[{key:"connect",value:function(e){var n=this;return r.info("CONNECT",this.endpoint),this.disconnect().then((function(){return n.pc=new f(n.peerConnectionConfig),n.pc.onicecandidate=function(e){r.info("ON ICE CANDIDATE",e)},void 0===n.pc.addStream?e.getTracks().forEach((function(t){n.pc.addTrack(t,e)})):n.pc.addStream(e),Promise.resolve()})).then(this.createOffer.bind(this)).then(this.setLocalDescription.bind(this)).then(this.connectWebSocket.bind(this)).then((function(){return n.stream=e,e}))}},{key:"disconnect",value:function(){var e=this;r.info("DISCONNECT","");var n=new Promise((function(n,t){return e.stream&&e.stream.getTracks().forEach((function(e){e.stop()})),e.stream=null,n()})),t=new Promise((function(n,t){return e.pc&&e.pc.close(),e.pc=null,n()})),o=new Promise((function(n,t){return e.ws&&e.ws.close(),e.ws=null,n()}));return Promise.all([n,t,o])}},{key:"createOffer",value:function(){var e=this;return this.pc.createOffer().then((function(n){return n.sdp=e.createSignalingMessage(n.sdp),n}))}},{key:"connectWebSocket",value:function(e){var n=this;return new Promise((function(t,o){n.ws=new WebSocket(n.endpoint),n.ws.binaryType="arraybuffer",n.ws.onopen=function(){r.info("WEBSOCKET ON OPEN",e),n.sendPublishMessage(e)},n.ws.onmessage=function(){var e=i(regeneratorRuntime.mark((function e(i){var a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.info("WEBSOCKET ON MESSAGE",i),a=JSON.parse(i.data),200===Number(a.status)){e.next=9;break}return e.next=6,n.disconnect();case 6:return e.abrupt("return",o(a));case 9:void 0!==a.sdp&&n.setRemoteDescription(a),n.addIceCandidates(a);case 11:null!==n.ws&&(n.ws.close(),n.ws=null),t();case 13:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),n.ws.onclose=function(){r.info("WEBSOCKET ON CLOSE","")},n.ws.onerror=function(){var e=i(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.error("WEBSOCKET ON ERROR",t),e.next=3,n.disconnect();case 3:o(t);case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}()}))}},{key:"sendPublishMessage",value:function(e){this.ws.send(JSON.stringify({direction:"publish",command:"sendOffer",streamInfo:this.streamInfo,sdp:e,userData:this.userData}))}},{key:"setLocalDescription",value:function(e){return this.pc.setLocalDescription(e).then((function(){return e}))}},{key:"setRemoteDescription",value:function(e){return this.pc.setRemoteDescription(new l(e.sdp))}},{key:"addIceCandidates",value:function(e){var n=this;r.info("ADD ICE CANDIDATES",e),void 0!==e.iceCandidates&&e.iceCandidates.forEach((function(e){n.pc.addIceCandidate(new d(e))}))}},{key:"createSignalingMessage",value:function(e){var n=this,t=e.split(/\r\n/),r="header",o=!1;e.includes("THIS_IS_SDPARTA")&&!this.videoConfig.codec.includes("VP9")||(t=t.filter((function(e){return 0!==e.length&&!!n.checkLine(e)})),t=this.addAudio(t,this.deliverCheckLine(this.audioConfig.codec,"audio")),t=this.addVideo(t,this.deliverCheckLine(this.videoConfig.codec,"video")));var i=[];return t.forEach((function(e){if(0!==e.length)if(0!=e.indexOf("m=audio")||-1===n.audioConfig.index)if(0!=e.indexOf("m=video")||-1===n.videoConfig.index){if(i.push(e),0===e.indexOf("m=audio")?(r="audio",o=!1):0===e.indexOf("m=video")?(r="video",o=!1):0===e.indexOf("a=rtpmap")&&(r="bandwidth",o=!1),(0===e.indexOf("a=mid:")||0===e.indexOf("a=rtpmap"))&&!o)if(0==="audio".localeCompare(r)){if(o=!0,void 0===n.audioConfig.bitRate)return;i=i.concat(["b=CT:".concat(n.audioConfig.bitRate),"b=AS:".concat(n.audioConfig.bitRate)])}else if(0==="video".localeCompare(r)){if(o=!0,void 0===n.videoConfig.bitRate)return;if(i=i.concat(["b=CT:".concat(n.videoConfig.bitRate),"b=AS:".concat(n.videoConfig.bitRate)]),void 0===n.videoConfig.frameRate)return;i.push("a=framerate:".concat(n.videoConfig.frameRate))}else if(0==="bandwidth".localeCompare(r)){var t=n.getrtpMapID(e);if(null===t)return;var a=t[2].toLowerCase(),c=n.genVideoBitRate(a,t[1],n.videoConfig.bitRate);void 0!==c&&i.push(c);var s=n.genAudioBitRate(a,t[1],n.audioConfig.bitRate);void 0!==s&&i.push(s)}}else{var u=e.split(" ");i.push("".concat(u[0]," ").concat(u[1]," ").concat(u[2]," ").concat(n.videoConfig.index))}else{var f=e.split(" ");i.push("".concat(f[0]," ").concat(f[1]," ").concat(f[2]," ").concat(n.audioConfig.index))}})),"".concat(i.join("\r\n"),"\r\n")}},{key:"addAudio",value:function(e,n){var t=[],r=!1;return e.forEach((function(e){0!==e.length&&(t.push(e),r||0==="a=rtcp-mux".localeCompare(e)&&(t=t.concat(n.split(/\r\n/)),r=!0))})),t}},{key:"addVideo",value:function(e,n){var t=[],r=!1,o=!1;return e.forEach((function(e){0!==e.length&&e.includes("a=rtcp-rsize")&&(o=!0)})),e.forEach((function(e){t.push(e),0==="a=rtcp-rsize".localeCompare(e)&&!1===r&&!0===o&&(t=t.concat(n.split(/\r\n/)),r=!0),0==="a=rtcp-mux".localeCompare(e)&&!0===r&&!1===o&&(t=t.concat(n.split(/\r\n/)),r=!0),0==="a=rtcp-mux".localeCompare(e)&&!1===r&&!1===o&&(r=!0)})),t}},{key:"deliverCheckLine",value:function(e,n){var t="";for(var r in this.SDPOutput){var o=this.SDPOutput[r];if(t+=r,o.includes(e)){if(e.includes("VP9")||e.includes("VP8")){var i="";return o.split(/\r\n/).forEach((function(e){-1===e.indexOf("transport-cc")&&-1===e.indexOf("goog-remb")&&-1===e.indexOf("nack")&&(i+=e+"\r\n")})),n.includes("audio")&&(this.audioConfig.index=r),n.includes("video")&&(this.videoConfig.index=r),i}return n.includes("audio")&&(this.audioConfig.index=r),n.includes("video")&&(this.videoConfig.index=r),o}}return t}},{key:"checkLine",value:function(e){if(!e.startsWith("a=rtpmap")&&!e.startsWith("a=rtcp-fb")&&!e.startsWith("a=fmtp"))return!0;var n=e.split(":");if(n.length<=1)return!0;var t=n[1].split(" ");if(isNaN(t[0]))return!0;if(t[1].startsWith("http")||t[1].startsWith("ur"))return!0;var r=this.SDPOutput[t[0]];return r||(r=""),r+=e+"\r\n",this.SDPOutput[t[0]]=r,!1}},{key:"genVideoBitRate",value:function(e,n,t){if((0==="vp9".localeCompare(e)||0==="vp8".localeCompare(e)||0==="h264".localeCompare(e)||0==="red".localeCompare(e)||0==="ulpfec".localeCompare(e)||0==="rtx".localeCompare(e))&&void 0!==t)return"a=fmtp:".concat(n," x-google-min-bitrate=").concat(t,";x-google-max-bitrate=").concat(t)}},{key:"genAudioBitRate",value:function(e,n,t){if((0==="opus".localeCompare(e)||0==="isac".localeCompare(e)||0==="g722".localeCompare(e)||0==="pcmu".localeCompare(e)||0==="pcma".localeCompare(e)||0==="cn".localeCompare(e))&&void 0!==t)return"a=fmtp:".concat(n," x-google-min-bitrate=").concat(t,";x-google-max-bitrate=").concat(t)}},{key:"getrtpMapID",value:function(e){var n=e.match(new RegExp("a=rtpmap:(\\d+) (\\w+)/(\\d+)"));return n&&n.length>=3?n:null}}])&&u(n.prototype,t),o&&u(n,o),e}();function h(e,n,t,r,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void t(e)}c.done?n(s):Promise.resolve(s).then(r,o)}function v(e){return function(){var n=this,t=arguments;return new Promise((function(r,o){var i=e.apply(n,t);function a(e){h(i,r,o,a,c,"next",e)}function c(e){h(i,r,o,a,c,"throw",e)}a(void 0)}))}}function m(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function b(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?m(Object(t),!0).forEach((function(n){g(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):m(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function g(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function C(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var w=window.RTCPeerConnection,y=window.RTCIceCandidate,O=window.RTCSessionDescription,E=function(){function e(n,t,r){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.stream=null,this.ws=null,this.pc=null,this.repeaterRetryCount=0,this.endpoint=n,this.streamInfo=t,this.userData={sessionId:t.sessionId},this.peerConnectionConfig={iceServers:[]},r&&(r.userData&&(this.userData=b({},this.userData,{},r.userData)),r.peerConnection&&(this.peerConnectionConfig=b({},this.peerConnectionConfig,{},r.peerConnection)))}var n,t,o;return n=e,(t=[{key:"connect",value:function(){var e=this;return this.disconnect().then((function(){return e.pc=new w(e.peerConnectionConfig),e.pc.onicecandidate=function(e){r.info("ON ICE CANDIDATE",e)},void 0===e.pc.ontrack?e.pc.onaddstream=function(e){r.info("ON ADD STREAM",e),this.stream=e.stream}.bind(e):e.pc.ontrack=function(e){r.info("ON TRACK",e),this.stream=e.streams[0]}.bind(e),Promise.resolve()})).then(this.connectWebSocket.bind(this)).then((function(){return r.info("FINISH",e.stream),{stream:e.stream,pc:e.pc}}))}},{key:"disconnect",value:function(){var e=this;r.info("DISCONNECT","");var n=new Promise((function(n,t){return e.stream&&e.stream.getTracks().forEach((function(e){e.stop()})),e.stream=null,n()})),t=new Promise((function(n,t){return e.pc&&e.pc.close(),e.pc=null,n()})),o=new Promise((function(n,t){return e.ws&&e.ws.close(),e.ws=null,n()}));return Promise.all([n,t,o])}},{key:"connectWebSocket",value:function(){var e=this;return new Promise((function(n,t){e.ws=new WebSocket(e.endpoint),e.ws.binaryType="arraybuffer",e.ws.onopen=function(){r.info("WEBSOCKET ON OPEN",""),e.sendPlayMessage()},e.ws.onmessage=function(){var o=v(regeneratorRuntime.mark((function o(i){var a,c,s,u;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(r.info("WEBSOCKET ON MESSAGE",i),a=JSON.parse(i.data),c=Number(a.status),s=a.command,514!==c){o.next=17;break}if(e.repeaterRetryCount++,!(e.repeaterRetryCount<10)){o.next=10;break}r.error("ERROR RESPONSE",a),o.next=15;break;case 10:return o.next=12,e.disconnect();case 12:return(u=new Error).message="repeater retry fail",o.abrupt("return",t(u));case 15:o.next=26;break;case 17:if(200===c){o.next=23;break}return o.next=20,e.disconnect();case 20:return o.abrupt("return",t(a));case 23:void 0!==a.streamInfo&&(e.streamInfo.sessionId=a.streamInfo.sessionId),void 0!==a.sdp&&e.setRemoteDescription(a).then((function(){return e.pc.createAnswer().then((function(n){return e.setLocalDescription(n)}))})).then(e.sendAnswer.bind(e)),e.addIceCandidates(a);case 26:if(0==="sendResponse".localeCompare(s)&&(null!==e.ws&&(e.ws.close(),e.ws=null),n()),0!=="getAvailableStreams".localeCompare(s)){o.next=30;break}return o.next=30,e.disconnect();case 30:case"end":return o.stop()}}),o)})));return function(e){return o.apply(this,arguments)}}(),e.ws.onclose=function(){r.info("WEBSOCKET ON CLOSE","")},e.ws.onerror=function(){var n=v(regeneratorRuntime.mark((function n(o){return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r.error("WEBSOCKET ON ERROR",o),n.next=3,e.disconnect();case 3:t(o);case 4:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}()}))}},{key:"addIceCandidates",value:function(e){var n=this;r.info("ADD ICE CANDIDATES",e),void 0!==e.iceCandidates&&e.iceCandidates.forEach((function(e){n.pc.addIceCandidate(new y(e))}))}},{key:"setLocalDescription",value:function(e){return r.info("SET LOCAL DESCRIPTION",e),this.pc.setLocalDescription(e).then((function(){return e}))}},{key:"setRemoteDescription",value:function(e){return this.pc.setRemoteDescription(new O(e.sdp))}},{key:"sendPlayMessage",value:function(){return this.ws.send(JSON.stringify({direction:"play",command:"getOffer",streamInfo:this.streamInfo,userData:this.userData})),Promise.resolve()}},{key:"sendGetAvailableStreams",value:function(){return this.ws.send(JSON.stringify({direction:"play",command:"getAvailableStreams",streamInfo:this.streamInfo,userData:this.userData})),Promise.resolve()}},{key:"sendAnswer",value:function(e){return r.info("SEND ANSWER",e),this.ws.send(JSON.stringify({direction:"play",command:"sendResponse",streamInfo:this.streamInfo,sdp:e})),Promise.resolve()}},{key:"getPeerConnection",value:function(){return this.pc}}])&&C(n.prototype,t),o&&C(n,o),e}();function S(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var P=function(){function e(n,t,r,o){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.endpoint=n,this.streamInfo={applicationName:t,streamName:r,sessionId:o}}var n,t,r;return n=e,(t=[{key:"publisher",value:function(e){return new p(this.endpoint,this.streamInfo,e)}},{key:"subscriber",value:function(e){return new E(this.endpoint,this.streamInfo,e)}}])&&S(n.prototype,t),r&&S(n,r),e}()}])}));